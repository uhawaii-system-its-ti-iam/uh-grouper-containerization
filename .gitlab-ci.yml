# .gitlab-ci.yml - GitLab pipeline image build instructions
#
# Deployment is triggered by changing portainer/stack.yml. Be sure to
# bump up the image file build id by +1 here and in stack.yml
# before committing the changes back to the repository.
#
stages:
  - build

build-job:
  image: quay.io/buildah/stable
  stage: build
  variables:
    # Bump the build id here and in stack.yml to trigger a new deployment.
    BUILD_ID: 117
    # Update build.args & stack.yml for Grouper version changes.
    GROUPER_VERSION: 4.2.0
    # Also update build.gradle & portainer/stack.yml if the image name changes.
    GROUPER_IMAGE_NAME: $CI_REGISTRY:5001/iam/uh-grouper/grouper:$GROUPER_VERSION
    GROUPER_IMAGE_TAG: $GROUPER_IMAGE_NAME-$CI_COMMIT_BRANCH-$CI_COMMIT_SHORT_SHA
    GROUPER_BUILD_ID: $GROUPER_IMAGE_NAME-$BUILD_ID
    ## logrotate ##
    LINUX_IMAGE: quay.io/rockylinux/rockylinux:latest
    LOGROTATE_IMAGE: $CI_REGISTRY:5001/iam/uh-grouper/logrotate-grouper:1.0.0
    LOGROTATE_LATEST: $CI_REGISTRY:5001/iam/uh-grouper/logrotate-grouper:latest
    LOGROTATE_BUILD_ID: $LOGROTATE_IMAGE-$BUILD_ID
  script:
    - buildah login --tls-verify=false -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY:5001
    - echo $CI_COMMIT_TIMESTAMP
    - buildah bud --build-arg-file=build.args -t $GROUPER_IMAGE_TAG .
    - buildah tag $GROUPER_IMAGE_TAG $GROUPER_IMAGE_NAME-$CI_COMMIT_BRANCH-latest
    - buildah tag $GROUPER_IMAGE_TAG $GROUPER_BUILD_ID
    - buildah push --tls-verify=false $GROUPER_IMAGE_TAG
    - buildah push --tls-verify=false $GROUPER_IMAGE_TAG $GROUPER_IMAGE_NAME-$CI_COMMIT_BRANCH-latest
    - buildah push --tls-verify=false $GROUPER_BUILD_ID
    - buildah pull $LINUX_IMAGE
    - buildah tag $LINUX_IMAGE $LOGROTATE_IMAGE
    - buildah bud --build-arg LOGROTATE_IMAGE=$LOGROTATE_IMAGE -t $LOGROTATE_IMAGE logrotate/Dockerfile
    - buildah tag $LOGROTATE_IMAGE $LOGROTATE_LATEST
    - buildah tag $LOGROTATE_IMAGE $LOGROTATE_BUILD_ID
    - buildah push --tls-verify=false $LOGROTATE_LATEST
    - buildah push --tls-verify=false $LOGROTATE_BUILD_ID
